---
sidebar_position: 6
---

# 从输入 URL 到页面呈现发生了什么

[[toc]]

## 大纲

首先是从流程上说明到底经过了哪些步骤，然后再一个一个对具体的步骤进行详细说明。

在输入 URL，例如`www.baidu.com`之后：

- 网络请求部分：
  - 查找强缓存
  - DNS 解析，找到 IP 地址
  - 建立 TCP 连接
  - 发送 HTTP 请求
  - 拿到 HTTP 响应
  - 断开 TCP 连接
- 解析部分：
  - 构建 DOM 树
  - 构建 CSSOM 树
  - 生成 render 树
  - 生成布局树
- 渲染部分：
  - 构建图层树
  - 生成绘制列表
  - 生成图块、位图
  - 显示器显示内容

## 网络请求部分

### 查找强缓存

如果命中强缓存，则直接使用。具体请见[浏览器存储](浏览器3.md)一章。

### DNS 解析

#### DNS 解析概念

在上面中，我们输入的`tlab.cloud.tencent.com`是**域名**。但是实际的数据包是通过**IP 地址**发送给对方的，因此我们首先需要根据域名获取**域名对应的 IP 地址**。

实现这个功能的系统就是 **DNS 系统**。他的任务就是将域名和 IP 一一映射。得到具体 IP 的过程就是 **DNS 解析**。

浏览器提供了**DNS 数据缓存**功能。即如果一个域名已经解析过，那会把解析的结果缓存下来，下次处理直接走缓存，不需要经过 DNS 解析。

#### 域名结构

DNS 是域名-IP 的对应关系，那么首先需要明确的是域名的结构。

```html
tlab.cloud.tencent.com
```

例子中的`.com`是顶级域名。顶级域名再向前就是二级、三级、……级域名。例子里面，`tencent`就是二级域名，`cloud`就是三级域名，`tlab`就是四级域名。

#### DNS 解析过程

整个解析流程按照下面的顺序进行：

- 浏览器缓存
  - 浏览器会持有一部分 DNS 缓存，这个缓存在一段时间内会过期，一般是几十秒。每种浏览器的 DNS 缓存过期时间都是固定的。
  - 在整个 DNS 解析过程中，浏览器缓存是最优先的。
- 本地 hosts 文件
  - 本地 host 文件可以手动定义域名-IP 的对应规则。
- 本地 DNS 缓存
  - 本地 host 文件没有的话，DNS 会首先查看本地 DNS 缓存。如果之前解析过这个域名，缓存中就会有对应的 IP 地址，可以直接获取。
- DNS 服务器缓存
  - 如果第一次访问某个地址，那么本地缓存肯定是没有的。这时候就需要去 DNS 服务器上查找。DNS 服务器有自己的缓存，首先在 DNS 服务器缓存区内进行查找。
- DNS 服务器递归查找

  - 如果在以上缓存区内都没有找到，就需要在 DNS 服务器上进行递归查找。递归查找的过程（以`tlab.cloud.tencent.com`为例）：
  - 询问根域名，获取顶级域名 `.com` 的 NS(Name Server) 和 A(Address)，NS 为顶级域名的名字，A 即 NS 对应的 ip 地址
  - 询问顶级域名，获取二级域名 `.tencnet.com` 的 NS 和 A
  - 询问二级域名，获取三级域名 `.cloud.tencent.com` 的 NS 和 A
  - 询问三级域名，获取四级域名 `.tlab.cloud.tencent.com` 的- NS 和 A
  - 最后，将 `tlab.cloud.tencent.com` 的 ip 地址返回给用户，并且缓- 存
  - 用户获取到真正的 ip 地址，并且缓存

  需要注意的是，**不是所有的递归查找都需要递归到最下级域名**才能找到 IP 地址的。如果在中间某一级查询中找到了所要的 IP 地址，就会直接返回，不会再继续进行递归。

### TCP 连接

目前 Chrome 规定一个域名下只能建立 6 个 TCP 连接。超出的话就需要等待。

TCP 连接的大致过程：

- 三次握手建立连接
- 四次挥手断开连接

关于 TCP 的详细知识在 [TCP/UDP](网络2.md) 中。

### HTTP 连接

HTTP 基于请求-响应模型。HTTP 的大致使用方法：

一个 HTTP 请求要携带三个东西：

- 请求行
  - 说明了请求方法、请求 URL、HTTP 版本协议。
- 请求头
  - 关于这个请求的一些控制信息。
- 请求体
  - 只有在 POST 方法下存在。常见场景是表单提交。

类似的，一个 HTTP 响应要携带三个东西：

- 响应行
  - 由 HTTP 版本、状态码、状态描述构成。
- 响应头
  - 包含一些数据的描述信息，cookie 信息等。
- 响应体
  - 返回的数据。

关于 HTTP 的详细知识在 [HTTP](网络1.md) 中。

## 解析部分

解析部分主要做了以下的事情：

- 解析 HTML，构建 DOM 树
- 解析 CSS，构建 CSSOM 树
- 上面两颗树结合生成 render 树
- 计算具体几何位置，生成布局树

具体细节可以在[浏览器解析与渲染](浏览器4.md)中查阅。

## 渲染部分

渲染部分主要做了以下的事情：

- 进行分层，建立图层树
- 将各个绘制指令按顺序生成绘制列表
- 合成线程利用绘制列表生成图块和生成位图
- 显示器显示内容

具体细节可以在[浏览器解析与渲染](浏览器4.md)中查阅。

## 参考出处

1. [神三元-浏览器灵魂之问](https://juejin.im/post/5df5bcea6fb9a016091def69#heading-0)
2. [小程序\_binnie-DNS 解析流程](https://juejin.im/post/5c303d6ff265da615b719aff)
