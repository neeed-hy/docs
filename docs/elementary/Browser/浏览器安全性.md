---
sidebar_position: 5
---

# 浏览器安全

[[toc]]

## XSS

### 什么是 XSS

XSS 全称 Cross Site Scripting(中文翻译跨站脚本)。为了和 CSS 区分，称之为 XSS。XSS 攻击是指浏览器中执行恶意脚本（无论是跨域还是同域）。XSS 的本质是 **html 注入**。

XSS 攻击一般可以完成这些事情：

- 窃取 cookie
- 监听用户行为，比如输入账号密码后直接发送到攻击者服务器
- 修改 DOM 伪造登录表单
- 在页面中生成浮窗广告

通常情况，XSS 攻击的实现有三种方式：**存储型、反射型、DOM 型**。

### 存储型

存储型 XSS 的攻击步骤：

1. 攻击者将恶意代码提交到目标网站的数据库中。
2. 用户打开目标网站时，网站服务端将恶意代码从数据库取出，拼接在 HTML 中返回给浏览器。
3. 用户浏览器接收到响应后解析执行，混在其中的恶意代码也被执行。

这种攻击常见于带有用户保存数据的网站功能，如论坛发帖、商品评论、用户私信等。

### 反射型

反射型 XSS 的攻击步骤：

1. 攻击者构造出特殊的 URL，其中包含恶意代码。
2. 用户打开带有恶意代码的 URL 时，网站服务端将恶意代码从 URL 中取出，拼接在 HTML 中返回给浏览器。
3. 用户浏览器接收到响应后解析执行，混在其中的恶意代码也被执行。
4. 恶意代码窃取用户数据并发送到攻击者的网站，或者冒充用户的行为，调用目标网站接口执行攻击者指定的操作。

反射型 XSS 跟存储型 XSS 的区别是：存储型 XSS 的恶意代码存在数据库里，反射型 XSS 的恶意代码存在 URL 里。

反射型 XSS 漏洞常见于通过 URL 传递参数的功能，如网站搜索、跳转等。

### DOM 型

DOM 型 XSS 的攻击步骤：

1. 攻击者构造出特殊的 URL，其中包含恶意代码。
2. 用户打开带有恶意代码的 URL。
3. 用户浏览器接收到响应后解析执行，前端 JavaScript 取出 URL 中的恶意代码并执行。
4. 恶意代码窃取用户数据并发送到攻击者的网站，或者冒充用户的行为，调用目标网站接口执行攻击者指定的操作。

DOM 型 XSS 跟前两种 XSS 的区别：DOM 型 XSS 攻击中，取出和执行恶意代码由浏览器端完成，属于前端 JavaScript 自身的安全漏洞，而其他两种 XSS 都属于服务端的安全漏洞。

### 防范措施

#### 整体思路

XSS 攻击有两大要素：

- 攻击者提交恶意代码
- 浏览器执行恶意代码

作为前端，最重要的阻止第二步，也就是阻止浏览器执行恶意代码。因为数据库在后端手里，里面有什么东西前端不可控。

存储型与反射型攻击都是由于服务端将恶意代码拼到 HTML 中，并将含有恶意代码的 HTML 返回给前端执行而产生的。  
常用解决方案是纯前端渲染，也就是首先生成一个静态 html，再利用 axios、ajax 等技术获取数据，再渲染到页面上。  
如果需要 SEO 或者其他需求，必须要服务端直接返回 HTML，那么必须要进行充分的字符串转义。

DOM 型攻击则需要前端进行严谨的编码，在生成 html 时仔细检查数据。
不过既然本质上 XSS 攻击是 html 注入，那么我们不通过 js 直接生成 html，就可以极大的避免这个问题。  
以 vue 技术栈为例，在开发过程中禁止使用 v-html，一般来说就不会出现 XSS 攻击的问题。

#### CSP

CSP，即浏览器中的内容安全策略，它的核心思想就是服务器决定浏览器加载哪些资源，具体来说可以完成以下功能:

限制其他域下的资源加载。
禁止向其它域提交数据。
提供上报机制，能帮助我们及时发现 XSS 攻击。

#### 利用 HttpOnly

XSS 攻击的主要目的之一就是窃取 cookie。给 cookie 设置 HttpOnly 后，JS 便无法读取 cookie 的值了。这样也可以提升安全性。

### XSS 总结

XSS 攻击是指浏览器中执行恶意脚本, 然后拿到用户的信息进行操作。

主要分为：

- 存储型
- 反射型
- DOM 型。

防范的措施包括:

- 纯前端渲染
- 进行严格的转义
- 禁止使用 js 生成 HTML
- 利用 CSP
- 利用 cookie 的 HttpOnly 属性

## CSRF

### 什么是 CSRF

CSRF(Cross-site request forgery), 即跨站请求伪造，指的是攻击者诱导用户点击链接，打开攻击者的网站，然后攻击者利用用户目前的登录状态发起跨站请求。

一个典型的 CSRF 攻击有着如下的流程：

- 受害者登录`a.com`，并保留了登录凭证（Cookie）。
- 攻击者引诱受害者访问了`b.com`。
- `b.com`向 `a.com` 发送了一个请求：`a.com/act=xx`。浏览器会默认携带 `a.com` 的 cookie。
- `a.com` 接收到请求后，对请求进行验证，并确认是受害者的凭证，误以为是受害者自己发送的请求。
- `a.com` 以受害者的名义执行了 act=xx。
- 攻击完成，攻击者在受害者不知情的情况下，冒充受害者，让 `a.com` 执行了自己定义的操作。

### 常见攻击类型

#### 自动发 GET

攻击者页面中可能有这样的代码：

```html
<img src="https://xxx.com/info?user=hhh&count=100" />
```

那么在进入页面后，就会自动发送 get 请求。这个请求会自动带上 `xxx.com` 的 cookie 信息。如果服务端没有相应的验证机制，他可能会认为这是一个正常的用户，携带了正常的 cookie。

#### 自动发 POST

攻击者页面中可能有这样的自动提交的表单：

```html
<form id="hacker-form" action="https://xxx.com/info" method="POST">
  <input type="hidden" name="user" value="hhh" />
  <input type="hidden" name="count" value="100" />
</form>
<script>
  document.getElementById("hacker-form").submit();
</script>
```

用户进入页面后就会自动发出 post 请求。

#### 诱导点击

在攻击者的网站上，可能会放上一个连接，诱导点击：

```html
<a href="https://xxx/info?user=hhh&count=100" taget="_blank">福利！</a>
```

用户点击后就会发送 get 请求。

### 如何防御

1. 利用 cookie 的 SameSite 属性。

   SameSite 是 cookie 中用来判断"是否同站"的属性。利用 SameSite，可以限制请求中 cookie 的携带。

2. 验证来源站点

   需要用到请求头中的两个字段：**Origin**和**Referer**。
   其中，Origin 只包含域名信息，而 Referer 包含了具体的 URL 路径。

   当然，这两者都是可以伪造的，通过自定义请求头即可，安全性略差。

3. CSRF Token

   首先，用户打开页面的时候，服务器需要给这个用户生成一个 Token 字符串返回。

   然后浏览器如果要发送请求，就必须带上这个字符串，然后服务器来验证是否合法，如果不合法则不予响应。这个字符串也就是 CSRF Token，通常第三方站点无法拿到这个 token, 因此也就是被服务器给拒绝。

### CSRF 总结

CSRF(Cross-site request forgery), 即跨站请求伪造，指的是攻击者诱导用户点击链接，打开攻击者的网站，然后攻击者利用用户目前的登录状态发起跨站请求。

CSRF 攻击一般会有三种方式:

- 自动 GET 请求
- 自动 POST 请求
- 诱导点击发送 GET 请求。

防范措施:

- 利用 Cookie 的 SameSite 属性
- 验证来源站点
- CSRF Token

## Https 让数据传输更安全

## 参考出处

1. [yck 小册](https://juejin.im/book/5bdc715fe51d454e755f75ef/section/5bdc721851882516c33430a2)
2. [神三元-浏览器灵魂之问](https://juejin.im/post/5df5bcea6fb9a016091def69#heading-64)
3. [美团技术团队-前端安全系列（一）：如何防止 XSS 攻击？](https://juejin.im/post/5bad9140e51d450e935c6d64)
4. [美团技术团队-前端安全系列之二：如何防止 CSRF 攻击？](https://juejin.im/post/5bc009996fb9a05d0a055192)
